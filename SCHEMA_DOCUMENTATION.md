# Annadata Database Schema Documentation



## Database Models Overview

### 1. User Model
**Collection**: `users`

```javascript
{
  _id: ObjectId,
  email: String, // unique, required
  password: String, // hashed with bcrypt
  role: String, // 'farmer', 'vendor', 'consumer'
  name: String, // required
  phone: String, // unique, required
  location: {
    type: 'Point',
    coordinates: [longitude, latitude] // [Number, Number]
  },
  address: String,
  isActive: Boolean, // default: true
  createdAt: Date,
  updatedAt: Date
}
```

**Sample Data**:
```json
{
  "_id": "507f1f77bcf86cd799439011",
  "email": "farmer@annadata.com",
  "role": "farmer",
  "name": "Harpreet Singh Dhillon",
  "phone": "+919876543210",
  "location": {
    "type": "Point",
    "coordinates": [75.8573, 30.8408]
  },
  "address": "Village Khanna, Ludhiana, Punjab, India",
  "isActive": true,
  "createdAt": "2025-01-15T10:30:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

---

### 2. Product Model
**Collection**: `products`

```javascript
{
  _id: ObjectId,
  sellerId: ObjectId, // ref: 'User'
  name: String, // required, max 200 chars
  description: String, // max 1000 chars
  category: String, // enum: ['vegetables', 'fruits', 'grains', 'pulses', 'spices', 'herbs', 'dairy', 'other']
  price: Number, // required, min: 0
  unit: String, // enum: ['kg', 'gram', 'ton', 'piece', 'dozen', 'liter', 'bundle']
  availableQuantity: Number, // required, min: 0
  minimumOrderQuantity: Number, // default: 1, min: 1
  images: [String], // array of image URLs
  location: {
    type: 'Point',
    coordinates: [longitude, latitude]
  },
  isActive: Boolean, // default: true
  harvestDate: Date,
  expiryDate: Date,
  createdAt: Date,
  updatedAt: Date
}
```

**Sample Data**:
```json
{
  "_id": "507f1f77bcf86cd799439012",
  "sellerId": "507f1f77bcf86cd799439011",
  "name": "Fresh Tomatoes",
  "description": "Organic red tomatoes, freshly harvested from Punjab farms",
  "category": "vegetables",
  "price": 40,
  "unit": "kg",
  "availableQuantity": 100,
  "minimumOrderQuantity": 5,
  "images": ["/uploads/tomatoes-1.jpg"],
  "location": {
    "type": "Point",
    "coordinates": [75.8573, 30.8408]
  },
  "isActive": true,
  "harvestDate": "2025-01-13T00:00:00Z",
  "expiryDate": "2025-01-20T00:00:00Z",
  "createdAt": "2025-01-15T10:30:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

---

### 3. Order Model
**Collection**: `orders`

```javascript
{
  _id: ObjectId,
  buyerId: ObjectId, // ref: 'User'
  sellerId: ObjectId, // ref: 'User'
  products: [{
    productId: ObjectId, // ref: 'Product'
    name: String,
    quantity: Number,
    price: Number,
    unit: String
  }],
  totalAmount: Number, // required
  status: String, // enum: ['pending', 'confirmed', 'in_transit', 'delivered', 'cancelled']
  deliveryAddress: String,
  deliveryLocation: {
    type: 'Point',
    coordinates: [longitude, latitude]
  },
  deliveryDate: Date,
  notes: String,
  cancellationReason: String,
  createdAt: Date,
  updatedAt: Date
}
```

**Sample Data**:
```json
{
  "_id": "507f1f77bcf86cd799439013",
  "buyerId": "507f1f77bcf86cd799439014",
  "sellerId": "507f1f77bcf86cd799439011",
  "products": [{
    "productId": "507f1f77bcf86cd799439012",
    "name": "Fresh Tomatoes",
    "quantity": 10,
    "price": 40,
    "unit": "kg"
  }],
  "totalAmount": 400,
  "status": "confirmed",
  "deliveryAddress": "Model Town, Ludhiana, Punjab, India",
  "deliveryLocation": {
    "type": "Point",
    "coordinates": [75.8573, 30.8408]
  },
  "notes": "Please deliver in the morning",
  "createdAt": "2025-01-15T10:30:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

---

### 4. HardwareMessage Model (For Python ML Service)
**Collection**: `hardwaremessages`

```javascript
{
  _id: ObjectId,
  farmerId: ObjectId, // ref: 'User'
  sensorData: {
    ph: Number, // required, min: 0, max: 14
    nitrogen: Number, // required, min: 0
    phosphorus: Number, // required, min: 0
    potassium: Number, // required, min: 0
    humidity: Number, // required, min: 0
    rainfall: Number, // required, min: 0, max: 100
    temperature: Number // required, min: -50, max: 70
  },
  createdAt: Date,
  updatedAt: Date
}
```

**Sample Data**:
```json
{
  "_id": "507f1f77bcf86cd799439015",
  "farmerId": "507f1f77bcf86cd799439011",
  "sensorData": {
    "ph": 6.5,
    "nitrogen": 45,
    "phosphorus": 23,
    "potassium": 78,
    "humidity": 65,
    "rainfall": 3.2,
    "temperature": 25
  },
  "createdAt": "2025-01-15T10:30:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

---

### 5. CropRecommendation Model (Generated by Python ML Service)
**Collection**: `croprecommendations`

```javascript
{
  _id: ObjectId,
  farmerId: ObjectId, // ref: 'User'
  hardwareMessageId: ObjectId, // ref: 'HardwareMessage'
  recommendations: [{
    cropName: String, // required
    suitabilityScore: Number // required, min: 0, max: 100
  }],
  processingTime: Number, // milliseconds
  createdAt: Date,
  updatedAt: Date
}
```

**Sample Data**:
```json
{
  "_id": "507f1f77bcf86cd799439016",
  "farmerId": "507f1f77bcf86cd799439011",
  "hardwareMessageId": "507f1f77bcf86cd799439015",
  "recommendations": [
    {
      "cropName": "Tomato",
      "suitabilityScore": 85
    },
    {
      "cropName": "Wheat",
      "suitabilityScore": 78
    },
    {
      "cropName": "Rice",
      "suitabilityScore": 72
    }
  ],
  "processingTime": 1500,
  "createdAt": "2025-01-15T10:30:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

---

### 6. DiseaseReport Model
**Collection**: `diseasereports`

```javascript
{
  _id: ObjectId,
  farmerId: ObjectId, // ref: 'User'
  imageUrl: String, // required, validated URL format
  diseaseName: String, // required, max 200 chars
  treatment: String, // required, max 1000 chars
  createdAt: Date,
  updatedAt: Date
}
```

**Sample Data**:
```json
{
  "_id": "507f1f77bcf86cd799439017",
  "farmerId": "507f1f77bcf86cd799439011",
  "imageUrl": "/uploads/disease-sample-1.jpg",
  "diseaseName": "Tomato Blight",
  "treatment": "Apply copper-based fungicide every 7-10 days. Ensure proper air circulation between plants and avoid overhead watering.",
  "createdAt": "2025-01-15T10:30:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

---

### 7. Notification Model
**Collection**: `notifications`

```javascript
{
  _id: ObjectId,
  userId: ObjectId, // ref: 'User'
  title: String, // required, max 200 chars
  message: String, // required, max 1000 chars
  type: String, // enum: ['order', 'product', 'location', 'ml', 'system']
  isRead: Boolean, // default: false
  data: Object, // optional additional data
  createdAt: Date,
  updatedAt: Date
}
```

**Sample Data**:
```json
{
  "_id": "507f1f77bcf86cd799439018",
  "userId": "507f1f77bcf86cd799439011",
  "title": "New Order Received",
  "message": "You have received a new order for Fresh Tomatoes",
  "type": "order",
  "isRead": false,
  "data": {
    "orderId": "507f1f77bcf86cd799439013"
  },
  "createdAt": "2025-01-15T10:30:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

---

## For Python ML Service Developers

### Hardware Data Input Flow
1. **Hardware sensors** send data to Python service
2. **Python service** stores raw data in `HardwareMessage` collection
3. **Python service** processes data and generates `CropRecommendation`
4. **Backend API** reads both collections for frontend

### Required Python Operations

#### 1. Store Hardware Data
```python
# Insert new hardware message
hardware_data = {
    "farmerId": ObjectId("507f1f77bcf86cd799439011"),
    "sensorData": {
        "ph": 6.5,
        "nitrogen": 45,
        "phosphorus": 23,
        "potassium": 78,
        "humidity": 65,
        "rainfall": 3.2,
        "temperature": 25
    }
}
db.hardwaremessages.insert_one(hardware_data)
```

#### 2. Generate Crop Recommendations
```python
# After ML processing, store recommendations
recommendation_data = {
    "farmerId": ObjectId("507f1f77bcf86cd799439011"),
    "hardwareMessageId": ObjectId("507f1f77bcf86cd799439015"),
    "recommendations": [
        {"cropName": "Tomato", "suitabilityScore": 85},
        {"cropName": "Wheat", "suitabilityScore": 78},
        {"cropName": "Rice", "suitabilityScore": 72}
    ],
    "processingTime": 1500
}
db.croprecommendations.insert_one(recommendation_data)
```

#### 3. Query Latest Data
```python
# Get latest hardware data for a farmer
latest_hardware = db.hardwaremessages.find_one(
    {"farmerId": ObjectId("507f1f77bcf86cd799439011")},
    sort=[("createdAt", -1)]
)

# Get latest recommendations for a farmer
latest_recommendations = db.croprecommendations.find_one(
    {"farmerId": ObjectId("507f1f77bcf86cd799439011")},
    sort=[("createdAt", -1)]
)
```

---

## For Frontend Developers

### API Endpoints

#### Authentication
- `POST /api/auth/login` - User login
- `POST /api/auth/register` - User registration
- `GET /api/auth/verify-token` - Verify JWT token

#### Users
- `GET /api/users/profile` - Get current user profile
- `PUT /api/users/profile` - Update user profile
- `PUT /api/users/location` - Update user location

#### Products
- `GET /api/products` - Get products with filters
- `POST /api/products` - Create new product (Farmer/Vendor only)
- `GET /api/products/:id` - Get product by ID
- `PUT /api/products/:id` - Update product (Owner only)
- `DELETE /api/products/:id` - Delete product (Owner only)
- `GET /api/products/my-products` - Get user's products

#### Orders
- `GET /api/orders/my-orders` - Get user's orders
- `POST /api/orders` - Create new order
- `GET /api/orders/:id` - Get order by ID
- `PATCH /api/orders/:id/status` - Update order status

#### ML Services
- `GET /api/ml/hardware-messages` - Get hardware sensor data (Farmer only)
- `GET /api/ml/hardware-messages/latest` - Get latest hardware data (Farmer only)
- `GET /api/ml/crop-recommendations` - Get crop recommendations (Farmer only)
- `GET /api/ml/crop-recommendations/latest` - Get latest recommendations (Farmer only)
- `POST /api/ml/disease-detection` - Detect plant disease (Farmer only)
- `GET /api/ml/disease-reports` - Get disease reports (Farmer only)

#### Notifications
- `GET /api/notifications` - Get user notifications
- `POST /api/notifications/send` - Send notification
- `PATCH /api/notifications/:id/read` - Mark notification as read

### Sample API Responses

#### Get Products Response
```json
{
  "success": true,
  "message": "Products retrieved successfully",
  "data": {
    "products": [
      {
        "_id": "507f1f77bcf86cd799439012",
        "name": "Fresh Tomatoes",
        "description": "Organic red tomatoes",
        "category": "vegetables",
        "price": 40,
        "unit": "kg",
        "availableQuantity": 100,
        "minimumOrderQuantity": 5,
        "sellerId": {
          "_id": "507f1f77bcf86cd799439011",
          "name": "Harpreet Singh Dhillon",
          "phone": "+919876543210"
        }
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 5,
      "pages": 1
    }
  }
}
```

#### Get Latest Hardware Data Response
```json
{
  "success": true,
  "message": "Latest hardware message retrieved successfully",
  "data": {
    "message": {
      "_id": "507f1f77bcf86cd799439015",
      "farmerId": "507f1f77bcf86cd799439011",
      "sensorData": {
        "ph": 6.5,
        "nitrogen": 45,
        "phosphorus": 23,
        "potassium": 78,
        "humidity": 65,
        "rainfall": 3.2,
        "temperature": 25
      },
      "createdAt": "2025-01-15T10:30:00Z"
    }
  }
}
```

---

## Database Connection

### MongoDB Atlas URI
```
mongodb+srv://myselfshivangi08:indiA_1234@cluster1.goeqstp.mongodb.net/annadata?retryWrites=true&w=majority&appName=Cluster1
```

### Collections Summary
- `users` - User accounts (farmer, vendor, consumer)
- `products` - Marketplace products with MOQ
- `orders` - Order transactions
- `hardwaremessages` - Raw sensor data from hardware
- `croprecommendations` - ML-generated crop suggestions
- `diseasereports` - Disease detection results
- `notifications` - Push notifications

---

## Sample Login Credentials (After Seeding)

- **Farmer**: `farmer@annadata.com` / `Password123`
- **Vendor**: `vendor1@annadata.com` / `Password123`
- **Consumer**: `consumer1@annadata.com` / `Password123`

---

## Notes

1. **Geospatial Data**: All location fields use GeoJSON Point format `[longitude, latitude]`
2. **Timestamps**: All dates are in ISO 8601 format
3. **ObjectIds**: MongoDB ObjectIds are 24-character hex strings
4. **Validation**: All required fields are enforced at database level
5. **Indexes**: Optimized for common queries (user location, product search, etc.)
6. **Minimum Order Quantity**: Farmers can set MOQ for bulk sales
7. **Real-time Updates**: Use Socket.io for live order updates and notifications